---
title: "MA678 Final Project Report"
subtitle: "Predicting Auction price for CO2 Allowances under EU Cap and Trade"
author: "Ajay Krishnakumar"
format: pdf
editor: visual
---
```{r}
#| echo: false
#| message: false
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tseries)
library(ggplot2)
library(tidyverse)
library(reshape2)
library(car)
library(lubridate)
library(lme4)
```

```{r}
#| echo: false
#| message: false
#| output: false
#Reading in the documents I need:
brent_crude_prices<- read_excel("brent_crude_prices.xlsx")
co2_emissions_data<-read.csv("co2_emission.csv")
ftse<- read.csv("FTSE 100 Historical Data.csv")
eu_ets_data<-read_excel("EU-ETS-data.xlsx")
```

```{r}
#| echo: false
#| message: false
#| output: false
#Converting dates to the right format so I can join them:
eu_ets_data$Date<- as.Date(eu_ets_data$Date)
brent_crude_prices$Date<- as.Date(brent_crude_prices$Date)
ftse$Date<- mdy(ftse$Date)
ftse$Price<- as.numeric(str_replace(ftse$Price,",",""))
```

```{r}
#| echo: false
#| message: false
#| output: false
#Joining the three data frames:
auction_and_oil<- merge(x=eu_ets_data,y=brent_crude_prices, 
                         by="Date", all.x=TRUE) 

auction_and_oil<-auction_and_oil |> filter(is.na(auction_and_oil$`Europe Brent Spot Price FOB (Dollars per Barrel)`)==FALSE)

oil_prices<- auction_and_oil$`Europe Brent Spot Price FOB (Dollars per Barrel)`
#pacf(oil_prices, lag=10, pl=TRUE)

ets_stock_and_oil_data<- merge(x=auction_and_oil, y= ftse, by='Date', all.x=TRUE)
```

```{r}
#| echo: false
#| message: false
#| output: false
#First let's change auction name to just have EU, DE, PL or EUAA:

ets_stock_and_oil_data<- ets_stock_and_oil_data |> mutate(
                AuctionType = ifelse(str_detect(`Auction Name`, "EUAA")==TRUE,
                                                                        "EUAA",
                                                    str_sub(`Auction Name`,-2,)
), .after=`Auction Name`)
```

```{r}
#| echo: false
#| message: false
#| output: false

#Setting up lags, starting with EU_only_auction:
EU_only_auction<- ets_stock_and_oil_data |> filter(AuctionType=="EU") |> filter(
                                          is.na(`Auction Price €/tCO2`)==FALSE
)
eu_only_auction_price<-EU_only_auction$`Auction Price €/tCO2`

#pacf(eu_only_auction_price, lag=10, pl=TRUE)

#Auction Price Lag
Auction_Price_lag<- EU_only_auction$`Auction Price €/tCO2`[1:length(EU_only_auction$`Auction Price €/tCO2`)-1]
Auction_Price_lag<- c(0,Auction_Price_lag)
EU_only_with_lag<- EU_only_auction |> mutate(
                                          Auction_Price_lag= Auction_Price_lag, .after=`Auction Price €/tCO2`
)

#Maximum bid lag
Max_bid_lag<- EU_only_auction$`Maximum Bid €/tCO2`[1:length(EU_only_auction$`Maximum Bid €/tCO2`)-1]
Max_bid_lag<- c(0,Max_bid_lag)
EU_only_with_lag<- EU_only_with_lag |> mutate(
                                          Max_bid_lag= Max_bid_lag, .after=`Maximum Bid €/tCO2`
)

#Avg bids per bidder lag
Avg_num_bids_per_bidder_lag<- EU_only_auction$`Average number of bids per bidder`[1:length(EU_only_auction$`Average number of bids per bidder`)-1]
Avg_num_bids_per_bidder_lag<- c(0,Avg_num_bids_per_bidder_lag)
EU_only_with_lag<- EU_only_with_lag |> mutate(
                                          Avg_num_bids_per_bidder_lag= Avg_num_bids_per_bidder_lag, .after=`Average number of bids per bidder`
)

#Avg vol per bidder
Avg_vol_per_bidder_lag<- EU_only_auction$`Average volume bid per bidder`[1:length(EU_only_auction$`Average volume bid per bidder`)-1]
Avg_vol_per_bidder_lag<- c(0,Avg_vol_per_bidder_lag)
EU_only_with_lag<- EU_only_with_lag |> mutate(
                                          Avg_vol_per_bidder_lag= Avg_vol_per_bidder_lag, .after=`Average volume bid per bidder`
)

#oil price lag
EU_only_with_lag<- EU_only_with_lag |> rename(
                        oil_price = `Europe Brent Spot Price FOB (Dollars per Barrel)`
)
oil_price_lag<- EU_only_with_lag$oil_price[1:length(EU_only_with_lag$oil_price)-1]
oil_price_lag<- c(0,oil_price_lag)
EU_only_with_lag<- EU_only_with_lag |> mutate(
                                          oil_price_lag= oil_price_lag, .after= oil_price
)

#ftse price lag:
EU_only_with_lag<- EU_only_with_lag |> rename(
                        ftse_price = Price
)
ftse_price_lag<- EU_only_with_lag$ftse_price[1:length(EU_only_with_lag$ftse_price)-1]
ftse_price_lag<- c(0,ftse_price_lag)
EU_only_with_lag<- EU_only_with_lag |> mutate(
                                          ftse_price_lag= ftse_price_lag, .after= ftse_price
)

#Auction Volume tCO2 lag:

Auction_vol_lag<- EU_only_auction$`Auction Volume tCO2`[1:length(EU_only_auction$`Auction Volume tCO2`)-1]
Auction_vol_lag<- c(0,Auction_vol_lag)
EU_only_with_lag<- EU_only_with_lag |> mutate(
                                          Auction_vol_lag= Auction_vol_lag, .after=`Auction Volume tCO2`
)
```
```{r}
#Setting up lag for German Auctions
DE_only_auction<-ets_stock_and_oil_data |> filter(AuctionType=="DE") |> filter(
                                          is.na(`Auction Price €/tCO2`)==FALSE
)
DE_only_auction_price<- DE_only_auction$`Auction Price €/tCO2`
#pacf(DE_only_auction_price)


#Auction Price Lag
Auction_Price_lag<- DE_only_auction$`Auction Price €/tCO2`[1:length(DE_only_auction$`Auction Price €/tCO2`)-1]
Auction_Price_lag<- c(0,Auction_Price_lag)
DE_only_with_lag<- DE_only_auction |> mutate(
                                          Auction_Price_lag= Auction_Price_lag, .after=`Auction Price €/tCO2`
)

#Maximum bid lag
Max_bid_lag<- DE_only_auction$`Maximum Bid €/tCO2`[1:length(DE_only_auction$`Maximum Bid €/tCO2`)-1]
Max_bid_lag<- c(0,Max_bid_lag)
DE_only_with_lag<- DE_only_with_lag |> mutate(
                                          Max_bid_lag= Max_bid_lag, .after=`Maximum Bid €/tCO2`
)

#Avg bids per bidder lag
Avg_num_bids_per_bidder_lag<- DE_only_auction$`Average number of bids per bidder`[1:length(DE_only_auction$`Average number of bids per bidder`)-1]
Avg_num_bids_per_bidder_lag<- c(0,Avg_num_bids_per_bidder_lag)
DE_only_with_lag<- DE_only_with_lag |> mutate(
                                          Avg_num_bids_per_bidder_lag= Avg_num_bids_per_bidder_lag, .after=`Average number of bids per bidder`
)

#Avg vol per bidder
Avg_vol_per_bidder_lag<- DE_only_auction$`Average volume bid per bidder`[1:length(DE_only_auction$`Average volume bid per bidder`)-1]
Avg_vol_per_bidder_lag<- c(0,Avg_vol_per_bidder_lag)
DE_only_with_lag<- DE_only_with_lag |> mutate(
                                          Avg_vol_per_bidder_lag= Avg_vol_per_bidder_lag, .after=`Average volume bid per bidder`
)

#oil price lag
DE_only_with_lag<- DE_only_with_lag |> rename(
                        oil_price = `Europe Brent Spot Price FOB (Dollars per Barrel)`
)
oil_price_lag<- DE_only_with_lag$oil_price[1:length(DE_only_with_lag$oil_price)-1]
oil_price_lag<- c(0,oil_price_lag)
DE_only_with_lag<- DE_only_with_lag |> mutate(
                                          oil_price_lag= oil_price_lag, .after= oil_price
)

#ftse price lag:
DE_only_with_lag<- DE_only_with_lag |> rename(
                        ftse_price = Price
)
ftse_price_lag<- DE_only_with_lag$ftse_price[1:length(DE_only_with_lag$ftse_price)-1]
ftse_price_lag<- c(0,ftse_price_lag)
DE_only_with_lag<- DE_only_with_lag |> mutate(
                                          ftse_price_lag= ftse_price_lag, .after= ftse_price
)

#Auction Volume tCO2 lag:

Auction_vol_lag<- DE_only_auction$`Auction Volume tCO2`[1:length(DE_only_auction$`Auction Volume tCO2`)-1]
Auction_vol_lag<- c(0,Auction_vol_lag)
DE_only_with_lag<- DE_only_with_lag |> mutate(
                                          Auction_vol_lag= Auction_vol_lag, .after=`Auction Volume tCO2`
)

#Lag for Polish Auctions:
PL_only_auction<-ets_stock_and_oil_data |> filter(AuctionType=="PL") |> filter(
                                          is.na(`Auction Price €/tCO2`)==FALSE
)
PL_only_auction_price<- PL_only_auction$`Auction Price €/tCO2`
#pacf(PL_only_auction_price)


#Auction Price Lag
Auction_Price_lag<- PL_only_auction$`Auction Price €/tCO2`[1:length(PL_only_auction$`Auction Price €/tCO2`)-1]
Auction_Price_lag<- c(0,Auction_Price_lag)
PL_only_with_lag<- PL_only_auction |> mutate(
                                          Auction_Price_lag= Auction_Price_lag, .after=`Auction Price €/tCO2`
)

#Maximum bid lag
Max_bid_lag<- PL_only_auction$`Maximum Bid €/tCO2`[1:length(PL_only_auction$`Maximum Bid €/tCO2`)-1]
Max_bid_lag<- c(0,Max_bid_lag)
PL_only_with_lag<- PL_only_with_lag |> mutate(
                                          Max_bid_lag= Max_bid_lag, .after=`Maximum Bid €/tCO2`
)

#Avg bids per bidPLr lag
Avg_num_bids_per_bidder_lag<- PL_only_auction$`Average number of bids per bidder`[1:length(PL_only_auction$`Average number of bids per bidder`)-1]
Avg_num_bids_per_bidder_lag<- c(0,Avg_num_bids_per_bidder_lag)
PL_only_with_lag<- PL_only_with_lag |> mutate(
                                          Avg_num_bids_per_bidder_lag= Avg_num_bids_per_bidder_lag, .after=`Average number of bids per bidder`
)

#Avg vol per bidder
Avg_vol_per_bidder_lag<- PL_only_auction$`Average volume bid per bidder`[1:length(PL_only_auction$`Average volume bid per bidder`)-1]
Avg_vol_per_bidder_lag<- c(0,Avg_vol_per_bidder_lag)
PL_only_with_lag<- PL_only_with_lag |> mutate(
                                          Avg_vol_per_bidder_lag= Avg_vol_per_bidder_lag, .after=`Average volume bid per bidder`
)

#oil price lag
PL_only_with_lag<- PL_only_with_lag |> rename(
                        oil_price = `Europe Brent Spot Price FOB (Dollars per Barrel)`
)
oil_price_lag<- PL_only_with_lag$oil_price[1:length(PL_only_with_lag$oil_price)-1]
oil_price_lag<- c(0,oil_price_lag)
PL_only_with_lag<- PL_only_with_lag |> mutate(
                                          oil_price_lag= oil_price_lag, .after= oil_price
)

#ftse price lag:
PL_only_with_lag<- PL_only_with_lag |> rename(
                        ftse_price = Price
)
ftse_price_lag<- PL_only_with_lag$ftse_price[1:length(PL_only_with_lag$ftse_price)-1]
ftse_price_lag<- c(0,ftse_price_lag)
PL_only_with_lag<- PL_only_with_lag |> mutate(
                                          ftse_price_lag= ftse_price_lag, .after= ftse_price
)

#Auction Volume tCO2 lag:

Auction_vol_lag<- PL_only_auction$`Auction Volume tCO2`[1:length(PL_only_auction$`Auction Volume tCO2`)-1]
Auction_vol_lag<- c(0,Auction_vol_lag)
PL_only_with_lag<- PL_only_with_lag |> mutate(
                                          Auction_vol_lag= Auction_vol_lag, .after=`Auction Volume tCO2`
)

#Lag for EUAA Auctions:
EUAA_only_auction<-ets_stock_and_oil_data |> filter(AuctionType=="EUAA") |> filter(
                                          is.na(`Auction Price €/tCO2`)==FALSE
)
EUAA_only_auction_price<- EUAA_only_auction$`Auction Price €/tCO2`
#pacf(EUAA_only_auction_price)


#Auction Price Lag
Auction_Price_lag<- EUAA_only_auction$`Auction Price €/tCO2`[1:length(EUAA_only_auction$`Auction Price €/tCO2`)-1]
Auction_Price_lag<- c(0,Auction_Price_lag)
EUAA_only_with_lag<- EUAA_only_auction |> mutate(
                                          Auction_Price_lag= Auction_Price_lag, .after=`Auction Price €/tCO2`
)

#Maximum bid lag
Max_bid_lag<- EUAA_only_auction$`Maximum Bid €/tCO2`[1:length(EUAA_only_auction$`Maximum Bid €/tCO2`)-1]
Max_bid_lag<- c(0,Max_bid_lag)
EUAA_only_with_lag<- EUAA_only_with_lag |> mutate(
                                          Max_bid_lag= Max_bid_lag, .after=`Maximum Bid €/tCO2`
)

#Avg bids per bidPLr lag
Avg_num_bids_per_bidder_lag<- EUAA_only_auction$`Average number of bids per bidder`[1:length(EUAA_only_auction$`Average number of bids per bidder`)-1]
Avg_num_bids_per_bidder_lag<- c(0,Avg_num_bids_per_bidder_lag)
EUAA_only_with_lag<- EUAA_only_with_lag |> mutate(
                                          Avg_num_bids_per_bidder_lag= Avg_num_bids_per_bidder_lag, .after=`Average number of bids per bidder`
)

#Avg vol per bidder
Avg_vol_per_bidder_lag<- EUAA_only_auction$`Average volume bid per bidder`[1:length(EUAA_only_auction$`Average volume bid per bidder`)-1]
Avg_vol_per_bidder_lag<- c(0,Avg_vol_per_bidder_lag)
EUAA_only_with_lag<- EUAA_only_with_lag |> mutate(
                                          Avg_vol_per_bidder_lag= Avg_vol_per_bidder_lag, .after=`Average volume bid per bidder`
)

#oil price lag
EUAA_only_with_lag<- EUAA_only_with_lag |> rename(
                        oil_price = `Europe Brent Spot Price FOB (Dollars per Barrel)`
)
oil_price_lag<- EUAA_only_with_lag$oil_price[1:length(EUAA_only_with_lag$oil_price)-1]
oil_price_lag<- c(0,oil_price_lag)
EUAA_only_with_lag<- EUAA_only_with_lag |> mutate(
                                          oil_price_lag= oil_price_lag, .after= oil_price
)

#ftse price lag:
EUAA_only_with_lag<- EUAA_only_with_lag |> rename(
                        ftse_price = Price
)
ftse_price_lag<- EUAA_only_with_lag$ftse_price[1:length(EUAA_only_with_lag$ftse_price)-1]
ftse_price_lag<- c(0,ftse_price_lag)
EUAA_only_with_lag<- EUAA_only_with_lag |> mutate(
                                          ftse_price_lag= ftse_price_lag, .after= ftse_price
)

#Auction Volume tCO2 lag:

Auction_vol_lag<- EUAA_only_auction$`Auction Volume tCO2`[1:length(EUAA_only_auction$`Auction Volume tCO2`)-1]
Auction_vol_lag<- c(0,Auction_vol_lag)
EUAA_only_with_lag<- EUAA_only_with_lag |> mutate(
                                          Auction_vol_lag= Auction_vol_lag, .after=`Auction Volume tCO2`
)

#Merging, beginning with EU lag
EU_lag<- EU_only_with_lag |> select('Date',
                                    'AuctionType', 
                                    'Auction_Price_lag',
                                    'Max_bid_lag',
                                    'Avg_num_bids_per_bidder_lag',
                                    'Avg_vol_per_bidder_lag',
                                    'Auction_vol_lag',
                                    'oil_price_lag',
                                    'ftse_price_lag'
                                    )
ets_EU_only_lag<- merge(x=ets_stock_and_oil_data, y= EU_lag, by=c('Date', 'AuctionType'), all.x=TRUE)
ets_EU_only_lag<- ets_EU_only_lag |> select(-c(Open:Change..))


lagColnamesVec<- c('Auction_Price_lag',
                                    'Max_bid_lag',
                                    'Avg_num_bids_per_bidder_lag',
                                    'Avg_vol_per_bidder_lag',
                                    'Auction_vol_lag',
                                    'oil_price_lag',
                                    'ftse_price_lag')

#DE lag:
DE_lag<- DE_only_with_lag |> select('Date',
                                    'AuctionType', 
                                    'Auction_Price_lag',
                                    'Max_bid_lag',
                                    'Avg_num_bids_per_bidder_lag',
                                    'Avg_vol_per_bidder_lag',
                                    'Auction_vol_lag',
                                    'oil_price_lag',
                                    'ftse_price_lag'
                                    )
ets_EU_DE_with_lag<- merge(x=ets_EU_only_lag, y=DE_lag, by=c('Date', 'AuctionType'), all.x=TRUE)


for(name in lagColnamesVec){
  x=paste0(name,".x")
  y=paste0(name,".y")
  ets_EU_DE_with_lag[,x]<-ifelse(is.na(ets_EU_DE_with_lag[,x]), 
                                  ets_EU_DE_with_lag[,y],
                                  ets_EU_DE_with_lag[,x])
}


ets_EU_DE_with_lag<- ets_EU_DE_with_lag |> rename(
                                    'Auction_Price_lag'= 'Auction_Price_lag.x',
                                    'Max_bid_lag'= 'Max_bid_lag.x',
                                    'Avg_num_bids_per_bidder_lag'='Avg_num_bids_per_bidder_lag.x',
                                    'Avg_vol_per_bidder_lag'='Avg_vol_per_bidder_lag.x',
                                    'Auction_vol_lag'= 'Auction_vol_lag.x',
                                    'oil_price_lag'= 'oil_price_lag.x',
                                    'ftse_price_lag'='ftse_price_lag.x'
                                    ) |> select(-c('Auction_Price_lag.y',
                                    'Max_bid_lag.y',
                                    'Avg_num_bids_per_bidder_lag.y',
                                    'Avg_vol_per_bidder_lag.y',
                                    'Auction_vol_lag.y',
                                    'oil_price_lag.y',
                                    'ftse_price_lag.y'))

#PL lag:
PL_lag<- PL_only_with_lag |> select('Date',
                                    'AuctionType', 
                                    'Auction_Price_lag',
                                    'Max_bid_lag',
                                    'Avg_num_bids_per_bidder_lag',
                                    'Avg_vol_per_bidder_lag',
                                    'Auction_vol_lag',
                                    'oil_price_lag',
                                    'ftse_price_lag'
                                    )
ets_EU_DE_PL_with_lag<- merge(x=ets_EU_DE_with_lag, 
                              y= PL_lag, by = c('Date', 'AuctionType'),
                              all.x=TRUE)

for(name in lagColnamesVec){
  x=paste0(name,".x")
  y=paste0(name,".y")
  ets_EU_DE_PL_with_lag[,x]<-ifelse(is.na(ets_EU_DE_PL_with_lag[,x]), 
                                  ets_EU_DE_PL_with_lag[,y],
                                  ets_EU_DE_PL_with_lag[,x])
}

ets_EU_DE_PL_with_lag<- ets_EU_DE_PL_with_lag |> rename(
                                    'Auction_Price_lag'= 'Auction_Price_lag.x',
                                    'Max_bid_lag'= 'Max_bid_lag.x',
                                    'Avg_num_bids_per_bidder_lag'='Avg_num_bids_per_bidder_lag.x',
                                    'Avg_vol_per_bidder_lag'='Avg_vol_per_bidder_lag.x',
                                    'Auction_vol_lag'= 'Auction_vol_lag.x',
                                    'oil_price_lag'= 'oil_price_lag.x',
                                    'ftse_price_lag'='ftse_price_lag.x'
                                    ) |> select(-c('Auction_Price_lag.y',
                                    'Max_bid_lag.y',
                                    'Avg_num_bids_per_bidder_lag.y',
                                    'Avg_vol_per_bidder_lag.y',
                                    'Auction_vol_lag.y',
                                    'oil_price_lag.y',
                                    'ftse_price_lag.y'))



#Adding EUAA lag:

EUAA_lag<- EUAA_only_with_lag |> select('Date',
                                    'AuctionType', 
                                    'Auction_Price_lag',
                                    'Max_bid_lag',
                                    'Avg_num_bids_per_bidder_lag',
                                    'Avg_vol_per_bidder_lag',
                                    'Auction_vol_lag',
                                    'oil_price_lag',
                                    'ftse_price_lag'
                                    )

ets_representative_lag<- merge(x=ets_EU_DE_PL_with_lag,
                               y=EUAA_lag, by = c('Date', 'AuctionType'),
                               all.x=TRUE)

for(name in lagColnamesVec){
  x=paste0(name,".x")
  y=paste0(name,".y")
  ets_representative_lag[,x]<-ifelse(is.na(ets_representative_lag[,x]), 
                                  ets_representative_lag[,y],
                                  ets_representative_lag[,x])
}

ets_representative_lag<- ets_representative_lag |> rename(
                                    'Auction_Price_lag'= 'Auction_Price_lag.x',
                                    'Max_bid_lag'= 'Max_bid_lag.x',
                                    'Avg_num_bids_per_bidder_lag'='Avg_num_bids_per_bidder_lag.x',
                                    'Avg_vol_per_bidder_lag'='Avg_vol_per_bidder_lag.x',
                                    'Auction_vol_lag'= 'Auction_vol_lag.x',
                                    'oil_price_lag'= 'oil_price_lag.x',
                                    'ftse_price_lag'='ftse_price_lag.x'
                                    ) |> select(-c('Auction_Price_lag.y',
                                    'Max_bid_lag.y',
                                    'Avg_num_bids_per_bidder_lag.y',
                                    'Avg_vol_per_bidder_lag.y',
                                    'Auction_vol_lag.y',
                                    'oil_price_lag.y',
                                    'ftse_price_lag.y'))

#Preparing data for a first differences procedure:

#Starting by transforming the variables:

ets_first_diff<- ets_representative_lag |> rename(
                  oil_price= `Europe Brent Spot Price FOB (Dollars per Barrel)`,
                  ftse_price = Price
)

#Maintaining a version of the data to use for EDA:
ets_modeling_data<- ets_first_diff

#We also need to add overall lags for oil and ftse prices that make more sense in the final model:

oil_price_lag_overall<- ets_modeling_data$oil_price[1:length(ets_modeling_data$oil_price)-1]
oil_price_lag_overall<- c(0,oil_price_lag_overall)
ets_modeling_data<- ets_modeling_data |> mutate(
                oil_price_lag_overall= oil_price_lag_overall
)

ftse_price_lag_overall<- ets_modeling_data$ftse_price[1:length(ets_modeling_data$ftse_price)-1]
ftse_price_lag_overall<- c(0,ftse_price_lag_overall)
ets_modeling_data<- ets_modeling_data |> mutate(
                ftse_price_lag_overall= ftse_price_lag_overall
)

ets_first_diff<-ets_first_diff |> mutate(
                  Auction_Price_fd = `Auction Price €/tCO2`- Auction_Price_lag,
                  Max_bid_fd = `Maximum Bid €/tCO2` - Max_bid_lag,
                  Avg_bids_fd= `Average number of bids per bidder` - Avg_num_bids_per_bidder_lag,
                  Avg_vol_fd= `Average volume bid per bidder`- Avg_vol_per_bidder_lag,
                  Auction_vol_fd = `Auction Volume tCO2`- Auction_vol_lag,
                  oil_price_fd = oil_price - oil_price_lag,
                  ftse_price_fd = ftse_price -ftse_price_lag
) |> select (
            Auction_Price_fd,
            Max_bid_fd,
            Avg_bids_fd,
            Avg_vol_fd,
            Auction_vol_fd,
            oil_price_fd,
            ftse_price_fd
)
```

## Abstract

The EU Cap and Trade system allows industrial placements, corporations and other eligible participants to auction off or purchase CO2 emissions allowances in the event of their having excess allowances or needing more allowances to avoid breaching their cap. This report endevors to look at variables dictating the auctions themselves and outside factors to predict the auction price and to establish to some extent whether booming business and industry relates to premiums on continued emissions of CO2 equivalents as measured by auction price.

## Introduction

### The EU Cap and Trade System

### Why predict Auction Price?

## Data - Sources and Initial Analysis:

The EU Emissions Trading System data I've used here comes from the website of the EEX (European Energy Exchange), the exchange licensed to run these auctions. The data goes back to 2017. 

A quick examination of the EU ETS(EU Emissions Trading System) data reveals that some metrics are naturally more appropriate to use in an analysis of this nature, especially considering the aims of this analysis are twofold:

-   To identify, from a strategic standpoint, at least as far as participants in the auction are concerned, what predicts auction price well: Clearly, in this scenario, averages work better than net results, especially given total numbers are typically restricted by eligibility of participants and changing policy measures.
    -   Further, averages might more readily reflect behavior individual parties in the auction might adapt. For example, if having a larger volume per bid seems to lower price, it would be in the interest of parties to bid in higher volumes although there would naturally be a point when total cost and per unit cost would need to be balanced. 
    -   Variables such as average bid per bidder and average volume per bidder are also interesting because it could be reasonably argued that they are representative of the level of demand for the CO2 allowances being auctioned. Similarly Auction Volume isn't just representative of supply - it is the supply. These two components are important, from a basic economic theory standpoint in predicting price, even auction price here. 
    -   One of the variables I'm especially interested in is the Maximum bid price. This is a really interesting variable because it seems that bidding really high is a viable method to win the auction as the auction clearing price is always resolved beneath the highest bid and the structure of the auction(see introduction above) would guarantee the highest bidder the allowances they seek. 

\*The other goal of this analysis is to see how economic performance for corporations affects CO2 allowance prices and whether this is at all reflective of incentives to reduce emissions.

To address the second goal of this analysis, data for the European Price of Brent Crude Oil per barrel was added, both as a measure of the prevailing price environment but also as an economic measure of costs for the installations and corporations covered by the Cap and Trade Regulation.

The value of the FTSE 100 index was added as further predictor(while Brexit has been an ongoing 'thing' since before the start of the time frame examined in this analysis, the LSE has mostly remained the largest European Exchange and the FTSE probably the best reflection of business performance across the pond). 

We can see from the figure below that FTSE and especially Oil Prices move really well with CO2 allowance Auction Prices and might therefore serve as good determinants of that price. They should also help inform how other auction variables such as volume and average bid size affect auction price controlling for macroeconomic effects

```{r}
#| echo: false
#| message: false
#| warning: false

suppressWarnings(
  ggplot(data=ets_modeling_data, aes(x=Date))+ geom_line(aes(y=oil_prices, color = 'Oil Prices'))+ geom_line(aes(y=`Auction Price €/tCO2`, color = 'Auction Prices' ))+geom_line(aes(y=ftse_price/100, color ='FTSE/100' ))+
          ggtitle("Graph 1: Auction Price, FTSE and Oil Price against Time")+
          xlab("Date")+ylab('Price/Index Value')+
    scale_color_manual(name = "Variables",values = c('#581845','#FFC300','#E13F35'))
  )
            
```


To further narrow down which variables we might use, correlation matrices were created and highly correlated predictors were eliminated. Similarly, we want variables that are at least a little well correlated with the outcome variable (Auction Price). Eliminating the variables that are highly correlated or which might not be meaningful predictors at least as far as interpretation is concerned, we get:

```{r}
eu_cor_frame<- ets_modeling_data |> select(`Auction Price €/tCO2`,`Auction Volume tCO2`, `Maximum Bid €/tCO2`,`Average number of bids per bidder`,
                                    oil_price, ftse_price) 

eu_cor_frame<- na.omit(eu_cor_frame)
cor_matrix<- cor(eu_cor_frame)

cor_matrix

```
We can see that between these four predictors of Auction price, we have pretty strong correlations. The correlations between predictors is a little bit stronger than we would like it to be but not enough to be problematic for our regression. Unfortunately, with economic data like this, its not going to be possible to find data with significantly lower correlations, especially with such measures as oil price and ftse price included. Nevertheless we shall explore below whether leaving those factors out gives us a better or worse model. 

Another consideration before we move on: The scale of the data above varies. We already had to transform the price of the FTSE 100 index in the graph above by dividing it by 100 to display it on the same scale as crude oil prices and CO2 allowance auction prices. Auction Volume is in the millions, average volume per bidder is in the hundreds of thousands while number of bids per bidder is in single digits. So we log those variables that are on a much larger scale. 

### The Time Series Dimension

Graph 1 above might have given you pause and made you think "Hold on, doesn't this look awfully like time series data?". That's because it does, and it is and that poses a problem in as much as time series data, being autocorrelated violates the condition of independence of errors for simple linear regression and OLS estimates. We can see the time series structure of the data in the graphs below and will discuss how to handle that. 

```{r}
ets_modeling_data<- na.omit(ets_modeling_data)
pacf(ets_modeling_data$`Auction Price €/tCO2`,lag=10, pl=TRUE, main="Graph 2 :
     Partial Autocorrelation for Auction Price €/tCO2")

pacf(ets_modeling_data$oil_price,lag=10, pl=TRUE, main="Graph 3 :
     Partial Autocorrelation for Price of Brent Crude Spot Price $/barrel")

pacf(ets_modeling_data$ftse_price,lag=10, pl=TRUE, main="Graph 4 :
     Partial Autocorrelation for FTSE-100")

```
All these variables have an AR(1) structure which is relatively typical of a lot of economic data. In order to model these appropriately, I added lag columns for our variables in the data(the code for this is in the appendix) and a first differences approach in the models below should help bring the Durbin Watson Statistic to acceptable levels. A first differences procedure is being used here because the literature I read indicates that for economic data the $\rho$ for AR(1) structures is generally high and First differences procedure is appropriate.(Penn State Applied Regression Analysis 10.3 - Regression with Autoregressive Errors: https://online.stat.psu.edu/stat462/node/189/). 

#### A little aside
Some of the auction data such as auction volume and number of bids per bidder have autoregression structures that are not as straightforward.  

```{r}
pacf(ets_modeling_data$`Average number of bids per bidder`, lag=10, pl=TRUE, main= "Graph 5:
     Partial Autocorrelation in \naverage number of bids per bidder")
pacf(ets_modeling_data$`Auction Volume tCO2`, lag = 10, pl = TRUE, main = "Graph 6: 
     Partial Autocorrelation in \nAverage volume in tons of CO2")
```
However, introducing a lag brings the level of the partial autocorrelation down to levels which are much more acceptable for this model, as we can glean from the graphs below.

Strictly speaking, we still have autocorrelation in multiple points above the level of significance and more advanced methods would need to be used to deal with this and would certainly contribute to a better performance of the models presented later in this paper.Unfortunately, that is beyond the scope of this project and is something to be left for future work.
```{r}
pacf(ets_modeling_data$`Average number of bids per bidder`- ets_modeling_data$Avg_num_bids_per_bidder_lag,
               lag=10, pl=TRUE, main= "Graph 7:
     Partial Autocorrelation in lag adjusted average number of bids per bidder")
pacf(ets_modeling_data$`Auction Volume tCO2`- ets_modeling_data$Auction_vol_lag,
lag = 10, pl = TRUE, main = "Graph 8: 
     Partial Autocorrelation in lag adjusted Average volume in tons of CO2")
```



