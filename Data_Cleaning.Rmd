---
title: "Data_Cleaning"
output: html_document
date: "2023-12-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tseries)
library(ggplot2)
library(tidyverse)
library(reshape2)
library(car)

```

Reading in the documents I need:
```{r}
brent_crude_prices<- read_excel("brent_crude_prices.xlsx")
co2_emissions_data<-read.csv("co2_emission.csv")
ftse<- read.csv("FTSE 100 Historical Data.csv")
eu_ets_data<-read_excel("EU-ETS-data.xlsx")
```

Converting dates to the right format so I can join them:

```{r}
eu_ets_data$Date<- as.Date(eu_ets_data$Date)
brent_crude_prices$Date<- as.Date(brent_crude_prices$Date)
ftse$Date<- as.Date(ftse$Date)
```

Joining the three data frames:

```{r}
auction_and_oil<- merge(x=eu_ets_data,y=brent_crude_prices, 
                         by="Date", all.x=TRUE) 

auction_and_oil<-auction_and_oil |> filter(is.na(auction_and_oil$`Europe Brent Spot Price FOB (Dollars per Barrel)`)==FALSE)

oil_prices<- auction_and_oil$`Europe Brent Spot Price FOB (Dollars per Barrel)`
pacf(oil_prices, lag=10, pl=TRUE)

ets_stock_and_oil_data<- merge(x=auction_and_oil, y= ftse, by='Date', all.x=TRUE)
```

Now we need to clean the ets_stock and oil data so we can get an appropriate lag and check autocorrelations for each type of data:
```{r}
#First let's change auction name to just have EU, DE, PL or EUAA:

ets_stock_and_oil_data<- ets_stock_and_oil_data |> mutate(
                AuctionType = ifelse(str_detect(`Auction Name`, "EUAA")==TRUE,
                                                                        "EUAA",
                                                    str_sub(`Auction Name`,-2,)
), .after=`Auction Name`)
```

So let's test autocorrelation for price, co2, etc each subset of the auctions. Starting with EU type:
```{r}
EU_only_auction<- ets_stock_and_oil_data |> filter(AuctionType=="EU") |> filter(
                                          is.na(`Auction Price €/tCO2`)==FALSE
)
eu_only_auction_price<-EU_only_auction$`Auction Price €/tCO2`

pacf(eu_only_auction_price, lag=10, pl=TRUE)


lag<- EU_only_auction$`Auction Price €/tCO2`[2:length(EU_only_auction$`Auction Price €/tCO2`)-1]
lag<- c(0,lag)
lag[length(lag)]<-0
EU_only_with_lag<- EU_only_auction |> mutate(
                                          lag= lag, .after=`Auction Price €/tCO2`
)

EU_only_auction_variables_fit<- glm(`Auction Price €/tCO2`~ lag+ `Auction Volume tCO2`+ `Maximum Bid €/tCO2`,
                            family=gaussian, data=EU_only_with_lag)

durbinWatsonTest(EU_only_auction_variables_fit)
summary(EU_only_auction_variables_fit)

#DW of 1.27. Not terrible. How do we push this up to acceptable levels?

#What about with oil prices?
EU_only_with_lag<- EU_only_with_lag |> rename(
                        oil_price = `Europe Brent Spot Price FOB (Dollars per Barrel)`
)

EU_only_oil_fit<- glm(`Auction Price €/tCO2`~ lag+ `Auction Volume tCO2`+ `Maximum Bid €/tCO2`+
                                    oil_price,
                            family=gaussian, data=EU_only_with_lag)
summary(EU_only_oil_fit)
durbinWatsonTest(EU_only_oil_fit)

pacf(EU_only_with_lag$oil_price, lag=20, pl=TRUE)

#So the difference in DW witha nd without oil prices isn't huge. Only 0.01 difference in the test statistic. 

```

Let's check the autoregressive correlation structure and Durbin-Watson for just the German auctions:

```{r}
DE_only_auction<-ets_stock_and_oil_data |> filter(AuctionType=="DE") |> filter(
                                          is.na(`Auction Price €/tCO2`)==FALSE
)
DE_only_auction_price<- DE_only_auction$`Auction Price €/tCO2`
pacf(DE_only_auction_price)


lag<- DE_only_auction$`Auction Price €/tCO2`[2:length(DE_only_auction$`Auction Price €/tCO2`)-1]
lag<- c(0,lag)
lag[length(lag)]<-0
DE_only_with_lag<- DE_only_auction |> mutate(
                                          lag= lag, .after=`Auction Price €/tCO2`
)

DE_only_auction_variables_fit<- glm(`Auction Price €/tCO2`~ lag+ `Auction Volume tCO2`+ `Maximum Bid €/tCO2`,
                            family=gaussian, data=DE_only_with_lag)

durbinWatsonTest(DE_only_auction_variables_fit)
summary(DE_only_auction_variables_fit)

#With oil prices:
DE_only_with_lag<- DE_only_with_lag |> rename(
                        oil_price = `Europe Brent Spot Price FOB (Dollars per Barrel)`
)

DE_only_oil_fit<- glm(`Auction Price €/tCO2`~ lag+ `Auction Volume tCO2`+ `Maximum Bid €/tCO2`+
                                    oil_price,
                            family=gaussian, data=DE_only_with_lag)
summary(DE_only_oil_fit)
durbinWatsonTest(DE_only_oil_fit)

pacf(DE_only_with_lag$oil_price, lag=20, pl=TRUE)

```

Fur Poland und nicht fur Deutschland:

```{r}
PL_only_auction<-ets_stock_and_oil_data |> filter(AuctionType=="PL") |> filter(
                                          is.na(`Auction Price €/tCO2`)==FALSE
)
PL_only_auction_price<- PL_only_auction$`Auction Price €/tCO2`
pacf(PL_only_auction_price)


lag<- PL_only_auction$`Auction Price €/tCO2`[2:length(PL_only_auction$`Auction Price €/tCO2`)-1]
lag<- c(0,lag)
lag[length(lag)]<-0
PL_only_with_lag<- PL_only_auction |> mutate(
                                          lag= lag, .after=`Auction Price €/tCO2`
)

PL_only_auction_variables_fit<- glm(`Auction Price €/tCO2`~ lag+ `Auction Volume tCO2`+ `Maximum Bid €/tCO2`,
                            family=gaussian, data=PL_only_with_lag)

durbinWatsonTest(PL_only_auction_variables_fit)
summary(PL_only_auction_variables_fit)

#With oil prices:
PL_only_with_lag<- PL_only_with_lag |> rename(
                        oil_price = `Europe Brent Spot Price FOB (Dollars per Barrel)`
)

PL_only_oil_fit<- glm(`Auction Price €/tCO2`~ lag+ `Auction Volume tCO2`+ `Maximum Bid €/tCO2`+
                                    oil_price,
                            family=gaussian, data=PL_only_with_lag)
summary(PL_only_oil_fit)
durbinWatsonTest(PL_only_oil_fit)

pacf(PL_only_with_lag$oil_price, lag=20, pl=TRUE)

#So for Poland, I don't need to worry about autocorrelation at all
```
What about EUAA:
```{r}
EUAA_only_auction<-ets_stock_and_oil_data |> filter(AuctionType=="EUAA") |> filter(
                                          is.na(`Auction Price €/tCO2`)==FALSE
)
EUAA_only_auction_price<- EUAA_only_auction$`Auction Price €/tCO2`
pacf(EUAA_only_auction_price)


lag<- EUAA_only_auction$`Auction Price €/tCO2`[2:length(EUAA_only_auction$`Auction Price €/tCO2`)-1]
lag<- c(0,lag)
lag[length(lag)]<-0
EUAA_only_with_lag<- EUAA_only_auction |> mutate(
                                          lag= lag, .after=`Auction Price €/tCO2`
)

EUAA_only_auction_variables_fit<- glm(`Auction Price €/tCO2`~ lag+ `Auction Volume tCO2`+ `Maximum Bid €/tCO2`,
                            family=gaussian, data=EUAA_only_with_lag)

durbinWatsonTest(EUAA_only_auction_variables_fit)
summary(EUAA_only_auction_variables_fit)

#With oil prices:
EUAA_only_with_lag<- EUAA_only_with_lag |> rename(
                        oil_price = `Europe Brent Spot Price FOB (Dollars per Barrel)`
)

EUAA_only_oil_fit<- glm(`Auction Price €/tCO2`~ lag+ `Auction Volume tCO2`+ `Maximum Bid €/tCO2`+
                                    oil_price,
                            family=gaussian, data=EUAA_only_with_lag)
summary(EUAA_only_oil_fit)
durbinWatsonTest(EUAA_only_oil_fit)

pacf(EUAA_only_with_lag$oil_price, lag=20, pl=TRUE)

#lag isn;t significant. Should I leave it out?
EUAA_only_oil_fit<- glm(`Auction Price €/tCO2`~ `Auction Volume tCO2`+ `Maximum Bid €/tCO2`+
                                    oil_price,
                            family=gaussian, data=EUAA_only_with_lag)
durbinWatsonTest(EUAA_only_oil_fit)
summary(EUAA_only_oil_fit)
```


```{r}
ets_rbind_lag<- rbind(
                                EU_only_with_lag, 
                                EUAA_only_with_lag, 
                                DE_only_with_lag, 
                                PL_only_with_lag) |> arrange(desc('Date'))

#Merging, beginning with EU lag
EU_lag<- EU_only_with_lag |> select('Date','AuctionType', 'lag')
ets_EU_only_lag<- merge(x=ets_stock_and_oil_data, y= EU_lag, by=c('Date', 'AuctionType'), all.x=TRUE)
ets_EU_only_lag<- ets_EU_only_lag |> select(-c(Price:Change..))

#DE lag:
DE_lag<- DE_only_with_lag |> select('Date', 'AuctionType', 'lag')
ets_EU_DE_with_lag<- merge(x=ets_EU_only_lag, y=DE_lag, by=c('Date', 'AuctionType'), all.x=TRUE)
ets_EU_DE_with_lag$lag.x<- ifelse(is.na(ets_EU_DE_with_lag$lag.x), 
                                  ets_EU_DE_with_lag$lag.y,
                                  ets_EU_DE_with_lag$lag.x)
ets_EU_DE_with_lag<- ets_EU_DE_with_lag |> rename('lag'='lag.x') |> select(-'lag.y')
```





## TO DO:
Have to join the lags for each subset to the whole data using joins by date and auction type. How much testing does this need(i.e how do i know i've done it right?)

Does adding stock prices also raise the DW statistic? For Germany above, the oil price addition raises the DW test statistic, probably because its so correlated with prices. 

