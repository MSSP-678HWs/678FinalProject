---
title: "Data_Cleaning"
output: html_document
date: "2023-12-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tseries)
library(ggplot2)
library(tidyverse)
library(reshape2)
library(car)
library(lubridate)

```

Reading in the documents I need:
```{r}
brent_crude_prices<- read_excel("brent_crude_prices.xlsx")
co2_emissions_data<-read.csv("co2_emission.csv")
ftse<- read.csv("FTSE 100 Historical Data.csv")
eu_ets_data<-read_excel("EU-ETS-data.xlsx")
```

Converting dates to the right format so I can join them:

```{r}
eu_ets_data$Date<- as.Date(eu_ets_data$Date)
brent_crude_prices$Date<- as.Date(brent_crude_prices$Date)
ftse$Date<- mdy(ftse$Date)
ftse$Price<- as.numeric(str_replace(ftse$Price,",",""))
```

Joining the three data frames:

```{r}
auction_and_oil<- merge(x=eu_ets_data,y=brent_crude_prices, 
                         by="Date", all.x=TRUE) 

auction_and_oil<-auction_and_oil |> filter(is.na(auction_and_oil$`Europe Brent Spot Price FOB (Dollars per Barrel)`)==FALSE)

oil_prices<- auction_and_oil$`Europe Brent Spot Price FOB (Dollars per Barrel)`
pacf(oil_prices, lag=10, pl=TRUE)

ets_stock_and_oil_data<- merge(x=auction_and_oil, y= ftse, by='Date', all.x=TRUE)
```

Now we need to clean the ets_stock and oil data so we can get an appropriate lag and check autocorrelations for each type of data:
```{r}
#First let's change auction name to just have EU, DE, PL or EUAA:

ets_stock_and_oil_data<- ets_stock_and_oil_data |> mutate(
                AuctionType = ifelse(str_detect(`Auction Name`, "EUAA")==TRUE,
                                                                        "EUAA",
                                                    str_sub(`Auction Name`,-2,)
), .after=`Auction Name`)
```

So let's test autocorrelation for price, co2, etc each subset of the auctions. Starting with EU type:
```{r}
EU_only_auction<- ets_stock_and_oil_data |> filter(AuctionType=="EU") |> filter(
                                          is.na(`Auction Price €/tCO2`)==FALSE
)
eu_only_auction_price<-EU_only_auction$`Auction Price €/tCO2`

pacf(eu_only_auction_price, lag=10, pl=TRUE)

#Auction Price Lag
Auction_Price_lag<- EU_only_auction$`Auction Price €/tCO2`[1:length(EU_only_auction$`Auction Price €/tCO2`)-1]
Auction_Price_lag<- c(0,Auction_Price_lag)
EU_only_with_lag<- EU_only_auction |> mutate(
                                          Auction_Price_lag= Auction_Price_lag, .after=`Auction Price €/tCO2`
)

#Maximum bid lag
Max_bid_lag<- EU_only_auction$`Maximum Bid €/tCO2`[1:length(EU_only_auction$`Maximum Bid €/tCO2`)-1]
Max_bid_lag<- c(0,Max_bid_lag)
EU_only_with_lag<- EU_only_with_lag |> mutate(
                                          Max_bid_lag= Max_bid_lag, .after=`Maximum Bid €/tCO2`
)

#Avg bids per bidder lag
Avg_num_bids_per_bidder_lag<- EU_only_auction$`Average number of bids per bidder`[1:length(EU_only_auction$`Average number of bids per bidder`)-1]
Avg_num_bids_per_bidder_lag<- c(0,Avg_num_bids_per_bidder_lag)
EU_only_with_lag<- EU_only_with_lag |> mutate(
                                          Avg_num_bids_per_bidder_lag= Avg_num_bids_per_bidder_lag, .after=`Average number of bids per bidder`
)

#Avg vol per bidder
Avg_vol_per_bidder_lag<- EU_only_auction$`Average volume bid per bidder`[1:length(EU_only_auction$`Average volume bid per bidder`)-1]
Avg_vol_per_bidder_lag<- c(0,Avg_vol_per_bidder_lag)
EU_only_with_lag<- EU_only_with_lag |> mutate(
                                          Avg_vol_per_bidder_lag= Avg_vol_per_bidder_lag, .after=`Average volume bid per bidder`
)

#oil price lag
EU_only_with_lag<- EU_only_with_lag |> rename(
                        oil_price = `Europe Brent Spot Price FOB (Dollars per Barrel)`
)
oil_price_lag<- EU_only_with_lag$oil_price[1:length(EU_only_with_lag$oil_price)-1]
oil_price_lag<- c(0,oil_price_lag)
EU_only_with_lag<- EU_only_with_lag |> mutate(
                                          oil_price_lag= oil_price_lag, .after= oil_price
)

#ftse price lag:
EU_only_with_lag<- EU_only_with_lag |> rename(
                        ftse_price = Price
)
ftse_price_lag<- EU_only_with_lag$ftse_price[1:length(EU_only_with_lag$ftse_price)-1]
ftse_price_lag<- c(0,ftse_price_lag)
EU_only_with_lag<- EU_only_with_lag |> mutate(
                                          ftse_price_lag= ftse_price_lag, .after= ftse_price
)

#Auction Volume tCO2 lag:

Auction_vol_lag<- EU_only_auction$`Auction Volume tCO2`[1:length(EU_only_auction$`Auction Volume tCO2`)-1]
Auction_vol_lag<- c(0,Auction_vol_lag)
EU_only_with_lag<- EU_only_with_lag |> mutate(
                                          Auction_vol_lag= Auction_vol_lag, .after=`Auction Volume tCO2`
)
##

EU_only_auction_variables_fit<- glm(`Auction Price €/tCO2`~ Auction_Price_lag+ `Auction Volume tCO2`+ `Maximum Bid €/tCO2`,
                            family=gaussian, data=EU_only_with_lag)

durbinWatsonTest(EU_only_auction_variables_fit)
summary(EU_only_auction_variables_fit)

#DW of 1.27. Not terrible. How do we push this up to acceptable levels?


#EU_only_oil_fit<- glm(`Auction Price €/tCO2`~ lag+ `Auction Volume tCO2`+ `Maximum Bid €/tCO2`+
 #                                   oil_price,
  #                          family=gaussian, data=EU_only_with_lag)
#summary(EU_only_oil_fit)
#durbinWatsonTest(EU_only_oil_fit)


#So the difference in DW witha nd without oil prices isn't huge. Only 0.01 difference in the test statistic. 

```

Let's check the autoregressive correlation structure and Durbin-Watson for just the German auctions:

```{r}
DE_only_auction<-ets_stock_and_oil_data |> filter(AuctionType=="DE") |> filter(
                                          is.na(`Auction Price €/tCO2`)==FALSE
)
DE_only_auction_price<- DE_only_auction$`Auction Price €/tCO2`
pacf(DE_only_auction_price)


#Auction Price Lag
Auction_Price_lag<- DE_only_auction$`Auction Price €/tCO2`[1:length(DE_only_auction$`Auction Price €/tCO2`)-1]
Auction_Price_lag<- c(0,Auction_Price_lag)
DE_only_with_lag<- DE_only_auction |> mutate(
                                          Auction_Price_lag= Auction_Price_lag, .after=`Auction Price €/tCO2`
)

#Maximum bid lag
Max_bid_lag<- DE_only_auction$`Maximum Bid €/tCO2`[1:length(DE_only_auction$`Maximum Bid €/tCO2`)-1]
Max_bid_lag<- c(0,Max_bid_lag)
DE_only_with_lag<- DE_only_with_lag |> mutate(
                                          Max_bid_lag= Max_bid_lag, .after=`Maximum Bid €/tCO2`
)

#Avg bids per bidder lag
Avg_num_bids_per_bidder_lag<- DE_only_auction$`Average number of bids per bidder`[1:length(DE_only_auction$`Average number of bids per bidder`)-1]
Avg_num_bids_per_bidder_lag<- c(0,Avg_num_bids_per_bidder_lag)
DE_only_with_lag<- DE_only_with_lag |> mutate(
                                          Avg_num_bids_per_bidder_lag= Avg_num_bids_per_bidder_lag, .after=`Average number of bids per bidder`
)

#Avg vol per bidder
Avg_vol_per_bidder_lag<- DE_only_auction$`Average volume bid per bidder`[1:length(DE_only_auction$`Average volume bid per bidder`)-1]
Avg_vol_per_bidder_lag<- c(0,Avg_vol_per_bidder_lag)
DE_only_with_lag<- DE_only_with_lag |> mutate(
                                          Avg_vol_per_bidder_lag= Avg_vol_per_bidder_lag, .after=`Average volume bid per bidder`
)

#oil price lag
DE_only_with_lag<- DE_only_with_lag |> rename(
                        oil_price = `Europe Brent Spot Price FOB (Dollars per Barrel)`
)
oil_price_lag<- DE_only_with_lag$oil_price[1:length(DE_only_with_lag$oil_price)-1]
oil_price_lag<- c(0,oil_price_lag)
DE_only_with_lag<- DE_only_with_lag |> mutate(
                                          oil_price_lag= oil_price_lag, .after= oil_price
)

#ftse price lag:
DE_only_with_lag<- DE_only_with_lag |> rename(
                        ftse_price = Price
)
ftse_price_lag<- DE_only_with_lag$ftse_price[1:length(DE_only_with_lag$ftse_price)-1]
ftse_price_lag<- c(0,ftse_price_lag)
DE_only_with_lag<- DE_only_with_lag |> mutate(
                                          ftse_price_lag= ftse_price_lag, .after= ftse_price
)

#Auction Volume tCO2 lag:

Auction_vol_lag<- DE_only_auction$`Auction Volume tCO2`[1:length(DE_only_auction$`Auction Volume tCO2`)-1]
Auction_vol_lag<- c(0,Auction_vol_lag)
DE_only_with_lag<- DE_only_with_lag |> mutate(
                                          Auction_vol_lag= Auction_vol_lag, .after=`Auction Volume tCO2`
)

#DE_only_oil_fit<- glm(`Auction Price €/tCO2`~ lag+ `Auction Volume tCO2`+ `Maximum Bid €/tCO2`+
#                                    oil_price,
 #                           family=gaussian, data=DE_only_with_lag)
#summary(DE_only_oil_fit)
#durbinWatsonTest(DE_only_oil_fit)

#pacf(DE_only_with_lag$oil_price, lag=20, pl=TRUE)

```

Fur Poland und nicht fur Deutschland:

```{r}
PL_only_auction<-ets_stock_and_oil_data |> filter(AuctionType=="PL") |> filter(
                                          is.na(`Auction Price €/tCO2`)==FALSE
)
PL_only_auction_price<- PL_only_auction$`Auction Price €/tCO2`
pacf(PL_only_auction_price)


#Auction Price Lag
Auction_Price_lag<- PL_only_auction$`Auction Price €/tCO2`[1:length(PL_only_auction$`Auction Price €/tCO2`)-1]
Auction_Price_lag<- c(0,Auction_Price_lag)
PL_only_with_lag<- PL_only_auction |> mutate(
                                          Auction_Price_lag= Auction_Price_lag, .after=`Auction Price €/tCO2`
)

#Maximum bid lag
Max_bid_lag<- PL_only_auction$`Maximum Bid €/tCO2`[1:length(PL_only_auction$`Maximum Bid €/tCO2`)-1]
Max_bid_lag<- c(0,Max_bid_lag)
PL_only_with_lag<- PL_only_with_lag |> mutate(
                                          Max_bid_lag= Max_bid_lag, .after=`Maximum Bid €/tCO2`
)

#Avg bids per bidPLr lag
Avg_num_bids_per_bidder_lag<- PL_only_auction$`Average number of bids per bidder`[1:length(PL_only_auction$`Average number of bids per bidder`)-1]
Avg_num_bids_per_bidder_lag<- c(0,Avg_num_bids_per_bidder_lag)
PL_only_with_lag<- PL_only_with_lag |> mutate(
                                          Avg_num_bids_per_bidder_lag= Avg_num_bids_per_bidder_lag, .after=`Average number of bids per bidder`
)

#Avg vol per bidder
Avg_vol_per_bidder_lag<- PL_only_auction$`Average volume bid per bidder`[1:length(PL_only_auction$`Average volume bid per bidder`)-1]
Avg_vol_per_bidder_lag<- c(0,Avg_vol_per_bidder_lag)
PL_only_with_lag<- PL_only_with_lag |> mutate(
                                          Avg_vol_per_bidder_lag= Avg_vol_per_bidder_lag, .after=`Average volume bid per bidder`
)

#oil price lag
PL_only_with_lag<- PL_only_with_lag |> rename(
                        oil_price = `Europe Brent Spot Price FOB (Dollars per Barrel)`
)
oil_price_lag<- PL_only_with_lag$oil_price[1:length(PL_only_with_lag$oil_price)-1]
oil_price_lag<- c(0,oil_price_lag)
PL_only_with_lag<- PL_only_with_lag |> mutate(
                                          oil_price_lag= oil_price_lag, .after= oil_price
)

#ftse price lag:
PL_only_with_lag<- PL_only_with_lag |> rename(
                        ftse_price = Price
)
ftse_price_lag<- PL_only_with_lag$ftse_price[1:length(PL_only_with_lag$ftse_price)-1]
ftse_price_lag<- c(0,ftse_price_lag)
PL_only_with_lag<- PL_only_with_lag |> mutate(
                                          ftse_price_lag= ftse_price_lag, .after= ftse_price
)

#Auction Volume tCO2 lag:

Auction_vol_lag<- PL_only_auction$`Auction Volume tCO2`[1:length(PL_only_auction$`Auction Volume tCO2`)-1]
Auction_vol_lag<- c(0,Auction_vol_lag)
PL_only_with_lag<- PL_only_with_lag |> mutate(
                                          Auction_vol_lag= Auction_vol_lag, .after=`Auction Volume tCO2`
)

#PL_only_oil_fit<- glm(`Auction Price €/tCO2`~ lag+ `Auction Volume tCO2`+ `Maximum Bid €/tCO2`+
 #                                   oil_price,
  #                          family=gaussian, data=PL_only_with_lag)
#summary(PL_only_oil_fit)
#durbinWatsonTest(PL_only_oil_fit)

#pacf(PL_only_with_lag$oil_price, lag=20, pl=TRUE)

#So for Poland, I don't need to worry about autocorrelation at all
```
What about EUAA:
```{r}
EUAA_only_auction<-ets_stock_and_oil_data |> filter(AuctionType=="EUAA") |> filter(
                                          is.na(`Auction Price €/tCO2`)==FALSE
)
EUAA_only_auction_price<- EUAA_only_auction$`Auction Price €/tCO2`
pacf(EUAA_only_auction_price)


#Auction Price Lag
Auction_Price_lag<- EUAA_only_auction$`Auction Price €/tCO2`[1:length(EUAA_only_auction$`Auction Price €/tCO2`)-1]
Auction_Price_lag<- c(0,Auction_Price_lag)
EUAA_only_with_lag<- EUAA_only_auction |> mutate(
                                          Auction_Price_lag= Auction_Price_lag, .after=`Auction Price €/tCO2`
)

#Maximum bid lag
Max_bid_lag<- EUAA_only_auction$`Maximum Bid €/tCO2`[1:length(EUAA_only_auction$`Maximum Bid €/tCO2`)-1]
Max_bid_lag<- c(0,Max_bid_lag)
EUAA_only_with_lag<- EUAA_only_with_lag |> mutate(
                                          Max_bid_lag= Max_bid_lag, .after=`Maximum Bid €/tCO2`
)

#Avg bids per bidPLr lag
Avg_num_bids_per_bidder_lag<- EUAA_only_auction$`Average number of bids per bidder`[1:length(EUAA_only_auction$`Average number of bids per bidder`)-1]
Avg_num_bids_per_bidder_lag<- c(0,Avg_num_bids_per_bidder_lag)
EUAA_only_with_lag<- EUAA_only_with_lag |> mutate(
                                          Avg_num_bids_per_bidder_lag= Avg_num_bids_per_bidder_lag, .after=`Average number of bids per bidder`
)

#Avg vol per bidder
Avg_vol_per_bidder_lag<- EUAA_only_auction$`Average volume bid per bidder`[1:length(EUAA_only_auction$`Average volume bid per bidder`)-1]
Avg_vol_per_bidder_lag<- c(0,Avg_vol_per_bidder_lag)
EUAA_only_with_lag<- EUAA_only_with_lag |> mutate(
                                          Avg_vol_per_bidder_lag= Avg_vol_per_bidder_lag, .after=`Average volume bid per bidder`
)

#oil price lag
EUAA_only_with_lag<- EUAA_only_with_lag |> rename(
                        oil_price = `Europe Brent Spot Price FOB (Dollars per Barrel)`
)
oil_price_lag<- EUAA_only_with_lag$oil_price[1:length(EUAA_only_with_lag$oil_price)-1]
oil_price_lag<- c(0,oil_price_lag)
EUAA_only_with_lag<- EUAA_only_with_lag |> mutate(
                                          oil_price_lag= oil_price_lag, .after= oil_price
)

#ftse price lag:
EUAA_only_with_lag<- EUAA_only_with_lag |> rename(
                        ftse_price = Price
)
ftse_price_lag<- EUAA_only_with_lag$ftse_price[1:length(EUAA_only_with_lag$ftse_price)-1]
ftse_price_lag<- c(0,ftse_price_lag)
EUAA_only_with_lag<- EUAA_only_with_lag |> mutate(
                                          ftse_price_lag= ftse_price_lag, .after= ftse_price
)

#Auction Volume tCO2 lag:

Auction_vol_lag<- EUAA_only_auction$`Auction Volume tCO2`[1:length(EUAA_only_auction$`Auction Volume tCO2`)-1]
Auction_vol_lag<- c(0,Auction_vol_lag)
EUAA_only_with_lag<- EUAA_only_with_lag |> mutate(
                                          Auction_vol_lag= Auction_vol_lag, .after=`Auction Volume tCO2`
)

#EUAA_only_auction_variables_fit<- glm(`Auction Price €/tCO2`~ lag+ `Auction Volume tCO2`+ `Maximum Bid €/tCO2`,
#                            family=gaussian, data=EUAA_only_with_lag)

#durbinWatsonTest(EUAA_only_auction_variables_fit)
#summary(EUAA_only_auction_variables_fit)

#With oil prices:
#EUAA_only_with_lag<- EUAA_only_with_lag |> rename(
#                        oil_price = `Europe Brent Spot Price FOB (Dollars per Barrel)`
#)

#EUAA_only_oil_fit<- glm(`Auction Price €/tCO2`~ lag+ `Auction Volume tCO2`+ `Maximum Bid €/tCO2`+
#                                    oil_price,
#                            family=gaussian, data=EUAA_only_with_lag)
#summary(EUAA_only_oil_fit)
#durbinWatsonTest(EUAA_only_oil_fit)

#pacf(EUAA_only_with_lag$oil_price, lag=20, pl=TRUE)

#lag isn;t significant. Should I leave it out?
#EUAA_only_oil_fit<- glm(`Auction Price €/tCO2`~ `Auction Volume tCO2`+ `Maximum Bid €/tCO2`+
 #                                   oil_price,
#                            family=gaussian, data=EUAA_only_with_lag)
#durbinWatsonTest(EUAA_only_oil_fit)
#summary(EUAA_only_oil_fit)
```


```{r}


#Merging, beginning with EU lag
EU_lag<- EU_only_with_lag |> select('Date',
                                    'AuctionType', 
                                    'Auction_Price_lag',
                                    'Max_bid_lag',
                                    'Avg_num_bids_per_bidder_lag',
                                    'Avg_vol_per_bidder_lag',
                                    'Auction_vol_lag',
                                    'oil_price_lag',
                                    'ftse_price_lag'
                                    )
ets_EU_only_lag<- merge(x=ets_stock_and_oil_data, y= EU_lag, by=c('Date', 'AuctionType'), all.x=TRUE)
ets_EU_only_lag<- ets_EU_only_lag |> select(-c(Open:Change..))


lagColnamesVec<- c('Auction_Price_lag',
                                    'Max_bid_lag',
                                    'Avg_num_bids_per_bidder_lag',
                                    'Avg_vol_per_bidder_lag',
                                    'Auction_vol_lag',
                                    'oil_price_lag',
                                    'ftse_price_lag')

#DE lag:
DE_lag<- DE_only_with_lag |> select('Date',
                                    'AuctionType', 
                                    'Auction_Price_lag',
                                    'Max_bid_lag',
                                    'Avg_num_bids_per_bidder_lag',
                                    'Avg_vol_per_bidder_lag',
                                    'Auction_vol_lag',
                                    'oil_price_lag',
                                    'ftse_price_lag'
                                    )
ets_EU_DE_with_lag<- merge(x=ets_EU_only_lag, y=DE_lag, by=c('Date', 'AuctionType'), all.x=TRUE)


for(name in lagColnamesVec){
  x=paste0(name,".x")
  y=paste0(name,".y")
  ets_EU_DE_with_lag[,x]<-ifelse(is.na(ets_EU_DE_with_lag[,x]), 
                                  ets_EU_DE_with_lag[,y],
                                  ets_EU_DE_with_lag[,x])
}


ets_EU_DE_with_lag<- ets_EU_DE_with_lag |> rename(
                                    'Auction_Price_lag'= 'Auction_Price_lag.x',
                                    'Max_bid_lag'= 'Max_bid_lag.x',
                                    'Avg_num_bids_per_bidder_lag'='Avg_num_bids_per_bidder_lag.x',
                                    'Avg_vol_per_bidder_lag'='Avg_vol_per_bidder_lag.x',
                                    'Auction_vol_lag'= 'Auction_vol_lag.x',
                                    'oil_price_lag'= 'oil_price_lag.x',
                                    'ftse_price_lag'='ftse_price_lag.x'
                                    ) |> select(-c('Auction_Price_lag.y',
                                    'Max_bid_lag.y',
                                    'Avg_num_bids_per_bidder_lag.y',
                                    'Avg_vol_per_bidder_lag.y',
                                    'Auction_vol_lag.y',
                                    'oil_price_lag.y',
                                    'ftse_price_lag.y'))

#PL lag:
PL_lag<- PL_only_with_lag |> select('Date',
                                    'AuctionType', 
                                    'Auction_Price_lag',
                                    'Max_bid_lag',
                                    'Avg_num_bids_per_bidder_lag',
                                    'Avg_vol_per_bidder_lag',
                                    'Auction_vol_lag',
                                    'oil_price_lag',
                                    'ftse_price_lag'
                                    )
ets_EU_DE_PL_with_lag<- merge(x=ets_EU_DE_with_lag, 
                              y= PL_lag, by = c('Date', 'AuctionType'),
                              all.x=TRUE)

for(name in lagColnamesVec){
  x=paste0(name,".x")
  y=paste0(name,".y")
  ets_EU_DE_PL_with_lag[,x]<-ifelse(is.na(ets_EU_DE_PL_with_lag[,x]), 
                                  ets_EU_DE_PL_with_lag[,y],
                                  ets_EU_DE_PL_with_lag[,x])
}

ets_EU_DE_PL_with_lag<- ets_EU_DE_PL_with_lag |> rename(
                                    'Auction_Price_lag'= 'Auction_Price_lag.x',
                                    'Max_bid_lag'= 'Max_bid_lag.x',
                                    'Avg_num_bids_per_bidder_lag'='Avg_num_bids_per_bidder_lag.x',
                                    'Avg_vol_per_bidder_lag'='Avg_vol_per_bidder_lag.x',
                                    'Auction_vol_lag'= 'Auction_vol_lag.x',
                                    'oil_price_lag'= 'oil_price_lag.x',
                                    'ftse_price_lag'='ftse_price_lag.x'
                                    ) |> select(-c('Auction_Price_lag.y',
                                    'Max_bid_lag.y',
                                    'Avg_num_bids_per_bidder_lag.y',
                                    'Avg_vol_per_bidder_lag.y',
                                    'Auction_vol_lag.y',
                                    'oil_price_lag.y',
                                    'ftse_price_lag.y'))



#Adding EUAA lag:

EUAA_lag<- EUAA_only_with_lag |> select('Date',
                                    'AuctionType', 
                                    'Auction_Price_lag',
                                    'Max_bid_lag',
                                    'Avg_num_bids_per_bidder_lag',
                                    'Avg_vol_per_bidder_lag',
                                    'Auction_vol_lag',
                                    'oil_price_lag',
                                    'ftse_price_lag'
                                    )

ets_representative_lag<- merge(x=ets_EU_DE_PL_with_lag,
                               y=EUAA_lag, by = c('Date', 'AuctionType'),
                               all.x=TRUE)

ets_representative_lag$lag.x<- ifelse(is.na(ets_representative_lag$lag.x), 
                                  ets_representative_lag$lag.y,
                                  ets_representative_lag$lag.x)

ets_representative_lag<- ets_representative_lag |> rename('lag'='lag.x') |> select(-'lag.y')

ets_representative_lag<- ets_representative_lag |> relocate(lag, 
                                  .after=`Auction Price €/tCO2`) |> rename(
             oil_price = `Europe Brent Spot Price FOB (Dollars per Barrel)`
                                  )
```

Now that we have lag set up correctly, let's regress with it and see how that affects our DW statistic:
```{r}
lag_fit<- glm(`Auction Price €/tCO2`~lag+`Auction Volume tCO2`+ `Maximum Bid €/tCO2`+
                                    oil_price,
                            family=gaussian, data=ets_representative_lag)

summary(lag_fit)

durbinWatsonTest(lag_fit)
```

Let's add stock prices and see what happens:
```{r}
ftse<- read.csv("FTSE 100 Historical Data.csv")

ftse$Date<- mdy(ftse$Date)
ftse$Price<- as.numeric(str_replace(ftse$Price,",",""))

ets_with_rep_lag<- merge(x=ets_representative_lag, y=ftse, by = 'Date', all.x=TRUE)

ets_with_rep_lag<- ets_with_rep_lag |> rename(
                                  ftse_price = Price
)

ftse_lag_fit<- glm(`Auction Price €/tCO2`~lag+`Auction Volume tCO2`+ `Maximum Bid €/tCO2`+
                                    oil_price+ftse_price,
                            family=gaussian, data=ets_with_rep_lag)

summary(ftse_lag_fit)

durbinWatsonTest(ftse_lag_fit)

```
Model diagnostics for the above model, especially a residuals plot"

```{r}
res<- resid(ftse_lag_fit)
plot(fitted(ftse_lag_fit), res)+abline(0,0)


```
Residuals are not pretty but there's no clear correlation issues. They are very close to zero. 

No pooling:
```{r}
#No pooling- EU:
  
no_pool_EU<- ets_with_rep_lag |> filter(AuctionType=="EU")

eu_no_pool_fit<- glm(`Auction Price €/tCO2`~lag+`Auction Volume tCO2`+ `Maximum Bid €/tCO2`+
                                    oil_price+ftse_price,
                            family=gaussian, data=no_pool_EU)

summary(eu_no_pool_fit)

durbinWatsonTest(eu_no_pool_fit)

```
We see with the EU only  that only maximum CO2 auction price remains significant. This is probably because the lag plays a much more significant role here. What can we do about this?
Let's look at residuals first:
```{r}
res<- resid(eu_no_pool_fit)
plot(fitted(eu_no_pool_fit), res)
```
While the DW is better for this model than for the last one, the residuals are worse and variance seems to increase with fitted values. Try log of ftse and oil?
```{r}
hist(no_pool_EU$oil_price)
hist(no_pool_EU$ftse_price)
hist(no_pool_EU$`Auction Volume tCO2`)
hist(no_pool_EU$`Maximum Bid €/tCO2`)
```
We can see from the histograms above that the skewed distribution comes from the ftse prices. So let's log those and see how our residuals look


```{r}
eu_no_pool_fit_log<- glm(`Auction Price €/tCO2`~`Maximum Bid €/tCO2`+`Auction Volume tCO2`+ `Average bid size`+
                                    oil_price+log(ftse_price),
                            family=gaussian, data=no_pool_EU)

summary(eu_no_pool_fit_log)

durbinWatsonTest(eu_no_pool_fit_log)
```

```{r}
eu_cor_frame<- ets_with_rep_lag |> select(`Auction Volume tCO2`, `Maximum Bid €/tCO2`,`Average bid size`,`Average volume bid per bidder`,
                                    oil_price, ftse_price) 

eu_cor_frame<- na.omit(eu_cor_frame)
cor_matrix<- cor(eu_cor_frame)

# Get upper triangle of the correlation matrix
get_upper_tri <- function(cormat){
  cormat[lower.tri(cormat)]<- NA
  return(cormat)
}

upper_tri <- get_upper_tri(cor_matrix)
melted_cormat <- melt(upper_tri, na.rm = TRUE)

ggplot(data = melted_cormat, aes(Var2, Var1, fill = value))+
  geom_tile(color = "white")+
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(-1,1), space = "Lab", 
                       name="Pearson\nCorrelation") +
  theme_minimal()+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, 
                                   size = 12, hjust = 1))+
  coord_fixed()
```
So i guess we need to pick better variables: Maximum bid and lag cannot both exist. 
In that case, instead of regressing lag, we'll have to transform out variables with the lag. 

Consider the following approaches:
*Cochrane-Orcutt
*Hildreth-Lu
*First Differences


#First Differences Procedure:

Which of the dependent variables do we need to create lags for?:
PACF time:
```{r}
ets_with_rep_lag<- na.omit(ets_with_rep_lag)
pacf(ets_with_rep_lag$`Maximum Bid €/tCO2`)
pacf(ets_with_rep_lag$`Average number of bids per bidder`)
pacf(ets_with_rep_lag$`Average volume bid per bidder`)
pacf(ets_with_rep_lag$oil_price)
pacf(ets_with_rep_lag$ftse_price)
pacf(ets_with_rep_lag$`Total Amount of Bids`)
pacf(ets_with_rep_lag$`Auction Volume tCO2`)
pacf(ets_with_rep_lag$`Auction Price €/tCO2`)
```
So pretty much all of them:

```{r}
#Creating lag for max price:

```





## TO DO:
Have to join the lags for each subset to the whole data using joins by date and auction type. How much testing does this need(i.e how do i know i've done it right?)(DONE)

Does adding stock prices also raise the DW statistic? For Germany above, the oil price addition raises the DW test statistic, probably because its so correlated with prices. (Yes it does. Brilliant)(DONE)

Do i need to pick my variables(the ones from within the auction dataset) better?

Partial and no pooling needs to be done. Vary intercept certainly. Vary slope too?

Can modifying the outcome variable according to first differences help the DW even though its in a good place now? how does DW lookf or partial and no pooling models?

